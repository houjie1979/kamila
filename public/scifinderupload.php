<?phprequire_once('../includes/initialize.php');$message = "";if(isset($_POST['upload'])){if(isset($_FILES['inputfile']['name'])){	$inputfile = UPLOAD_DIR.DS.$_FILES['inputfile']['name'];	if(move_uploaded_file($_FILES['inputfile']['tmp_name'],$inputfile)) {		$handle = fopen($inputfile, "r");		$fcontent = array();		$i = 0;		if(!isset($handle)) echo "can not open file";    		while (($buffer = fgets($handle)) !== false) {		switch(substr($buffer,0,10)){			case "START_RECO":				$newhold = array();			break;			case "FIELD Titl":				$newhold['article_title'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Acce":				$newhold['scisearch'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Abst":				$newhold['abstract'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Auth":				$newhold['intercomments'] = substr($buffer,strpos($buffer,":")+1);					$authlist = Names::parse_names($newhold['intercomments']);				if(isset($authlist[0])) $newhold['fauthor_code'] = $authlist[0]->author_key;				foreach((array)$authlist as $auth) {					$newhold['intercomments'] .=	" ".$auth->author_key;					if($auth->email != "")	$newhold['intercomments'] .=	"*";				}				$names = explode(";",$newhold['intercomments']);				switch(count($names)){					case 1:						if(strpos($names[0],",")) $last_name[0] = trim(substr($names[0],0,strpos($names[0],",")));						else $last_name[0] = trim(substr($names[0],0,strpos($names[0]," ")));						$auth_first_let = strtoupper(substr($last_name[0],0,3));					break;					case 2:						if(strpos($names[0],",")) $last_name[0] = trim(substr($names[0],0,strpos($names[0],",")));						else $last_name[0] = trim(substr(trim($names[0]),0,strpos(trim($names[0])," ")));						if(strpos($names[1],",")) $last_name[1] = trim(substr(trim($names[1]),0,strpos(trim($names[1]),",")));						else $last_name[1] = trim(substr(trim($names[1]),0,strpos(trim($names[1])," ")));						if((strlen($last_name[0]) < strlen($last_name[1])) && strlen($last_name[0]) == 1) {							$auth_first_let=strtoupper(substr($last_name[0],0,1).substr($last_name[1],0,2));							}							else 	$auth_first_let=strtoupper(substr($last_name[0],0,2).substr($last_name[1],0,1));											break;					default:						$auth_first_let = strtoupper(substr(trim($names[0]),0,1).substr(trim($names[1]),0,1).substr(trim($names[2]),0,1));				}				if(strlen($auth_first_let) == 1) $auth_first_let .="  ";				if(strlen($auth_first_let) == 2) $auth_first_let .=" ";							break;			case "FIELD Chem":				$newhold['chem_abs'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Docu": 				if(substr($buffer,strpos($buffer,":")+1,7) == "Journal") $newhold['type_code'] = "1"; 						break;			case "FIELD CODE":				$newhold['journal_code'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Jour":				$newhold['comments'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Full":				$newhold['journal_name'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Lang":				$newhold['writtenin'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Volu":				$newhold['vol'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Issu":				$newhold['issue'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Page":				$newhold['pages'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Publ":				if(substr($buffer,0,strpos($buffer,":")) == "FIELD Publication Year")				$newhold['year'] = substr($buffer,strpos($buffer,":")+1);				if($newhold['year'] == ""){					if(substr($buffer,0,strpos($buffer,":")) == "FIELD Publication Date")					$newhold['year'] = substr($buffer,strpos($buffer,":")+1);				}			break;			case "FIELD Inde":				if(substr($buffer,0,strpos($buffer,":")) == "FIELD Index Terms")				$newhold['index_terms'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD Cita":				$newhold['citations'] = substr($buffer,strpos($buffer,":")+1);						break;			case "FIELD DOI:":				$newhold['inspec'] = substr($buffer,strpos($buffer,":")+1);						break;			case "END_RECORD":				$hold_key = substr($newhold['year'],2,2).$auth_first_let;				$newhold['hold_key'] = Holdings::get_new_holdkey($hold_key,$newhold['year']);				$newhold['abstractor'] = $session->username;				$newhold['edate'] = date('Y-m-d');				$lang = explode(" ",$newhold['writtenin']);				$newhold['lang_code'] = Languages::get_lang_code($lang);//				$temp = $newhold['intercomments']."(1)".$newhold['fauthor_code'];//				array_push($fcontent, $newhold);				$new_hold = Holdings::instantiateit($newhold);				$fcontent[] = $new_hold;				$new_hold->save();			break;		}			}	// of while			fclose($handle);				unset($_FILES['inputfile']['name']);			}  // if move_uploaded		}	// if is_set//	if(isset($fcontent)) foreach($fcontent as $rec) $rec->save();	$message = count($fcontent)." records added to holding";}?><?php include_layout_template('header.php'); ?><div id="leftcol">	<form action="scifinderupload.php" enctype="multipart/form-data" method="post">		<input type="hidden" name="MAX_FILE_SIZE" value="500000" />		<p> File name:</p>		<input type="file" name="inputfile"  size="20"/>		<input type="submit" name="upload" value="Upload" />	</form>		  </br>		  </br><?php	echo $message."</br>"; ?></div>		<div id="data"><?php 	if(isset($fcontent)){		foreach($fcontent as $line)   echo $line->code_name()."</br>";	}?></div><?php include_layout_template('footer.php'); ?>		