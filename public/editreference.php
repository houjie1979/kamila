<?phprequire_once('../includes/initialize.php');if(isset($_POST['getref'])) {	// get reference Form has been submitted    $refkey = trim($_POST['refkey']);	$found_records = References::get_by_refkey($refkey);	$found_keys = Keywords::get_by_refkey($refkey,0);	$keywords = "";	if(isset($found_keys)) foreach($found_keys as $key) {$keywords .= $key->keyword_code." ";}	$ref = $found_records[0];	if(isset($ref)) { $ref->add_definitions(); $message = "Found Reference ".$refkey; } 	else $message = "Not found ".$refkey;}if(isset($_POST['save'])) {	// move reference Form has been submitted if($session->allow('enter')) {	$nref['id'] = trim($_POST['id']);	$nref['ref_key'] = trim($_POST['ref_key']);	$nref['medi_number'] = trim($_POST['medi_number']);	$nref['type_code'] = trim($_POST['type_code']);	$nref['journal_code'] = strtoupper(trim($_POST['journal_code']));	$nref['vol'] = trim($_POST['vol']);	$nref['issue'] = trim($_POST['issue']);	$nref['pages'] = trim($_POST['pages']);	$nref['year'] = trim($_POST['year']);	$nref['article_title'] = trim($_POST['article_title']);	$nref['lang_code'] = strtoupper(trim($_POST['lang_code']));	$nref['chem_abs'] = trim($_POST['chem_abs']);	$nref['asc_top'] = trim($_POST['asc_top']);	$nref['biosis'] = trim($_POST['biosis']);	$nref['inspec'] = trim($_POST['inspec']);	$nref['phys'] = trim($_POST['phys']);	$nref['energy'] = trim($_POST['energy']);	$nref['scisearch'] = trim($_POST['scisearch']);	$nref['ldate'] = trim($_POST['ldate']);	$nref['sdate'] = trim($_POST['sdate']);	$nref['rdate'] = trim($_POST['rdate']);	$nref['edate'] = trim($_POST['edate']);	$nref['abstractor'] = $session->username;	$nref['comments'] = trim($_POST['comments']);	$nref['see_ref_key'] = strtoupper(trim($_POST['see_ref_key']));	$nref['flag_code'] = strtoupper(trim($_POST['flag_code']));	$nref['abstract'] = trim($_POST['abstract']);	$nref['unsol_flag'] = strtoupper(trim($_POST['unsol_flag']));	$nref['citations'] = trim($_POST['citations']);	$nref['index_terms'] = trim($_POST['index_terms']);	$ref = References::instantiateit($nref);	$refkey = $ref->ref_key;	$ref->add_definitions();	if($ref->save()) 	$message = " Record updated ".$ref->ref_key;	else $message = " Could not update  ".$ref->ref_key;	$keywords =  strtoupper(trim($_POST['keywords']));	if($keywords != "") $allkeywords = Keycodes::parse_keyw_list($keywords);	$res = Keywords::replace_keywords($nref->ref_key,0,$allkeywords);	$saved = array_values($res);	$deleted = array_keys($res);	$message .= "</br> Keywords saved - ".$saved[0];	$message .= "</br> Keywords deleted - ".$deleted[0]; } else $message = "Update is not allowed";}if(isset($_POST['moveref'])) { if($session->allow('update')) {	$nref['ref_key'] = trim($_POST['nextref']);	$nref['medi_number'] = trim($_POST['medi_number']);	$nref['type_code'] = trim($_POST['type_code']);	$nref['journal_code'] = strtoupper(trim($_POST['journal_code']));	$nref['vol'] = trim($_POST['vol']);	$nref['issue'] = trim($_POST['issue']);	$nref['pages'] = trim($_POST['pages']);	$nref['year'] = trim($_POST['year']);	$nref['article_title'] = trim($_POST['article_title']);	$nref['lang_code'] = strtoupper(trim($_POST['lang_code']));	$nref['chem_abs'] = trim($_POST['chem_abs']);	$nref['asc_top'] = trim($_POST['asc_top']);	$nref['biosis'] = trim($_POST['biosis']);	$nref['inspec'] = trim($_POST['inspec']);	$nref['phys'] = trim($_POST['phys']);	$nref['energy'] = trim($_POST['energy']);	$nref['scisearch'] = trim($_POST['scisearch']);	$nref['ldate'] = trim($_POST['ldate']);	$nref['sdate'] = trim($_POST['sdate']);	$nref['rdate'] = trim($_POST['rdate']);	$nref['edate'] = trim($_POST['edate']);	$nref['abstractor'] = $session->username;	$nref['comments'] = trim($_POST['comments']);	$nref['see_ref_key'] = strtoupper(trim($_POST['see_ref_key']));	$nref['flag_code'] = strtoupper(trim($_POST['flag_code']));	$nref['abstract'] = trim($_POST['abstract']);	$nref['unsol_flag'] = strtoupper(trim($_POST['unsol_flag']));	$nref['citations'] = trim($_POST['citations']);	$nref['index_terms'] = trim($_POST['index_terms']);	$ref = References::instantiateit($nref);	$refkey = $ref->ref_key;	$ref->add_definitions();	$newrefsaved = $ref->save();	if($newrefsaved)	$message = " Record saved ".$ref->ref_key;	else $message = "Could not save ".$ref->ref_key;	$keywords =  strtoupper(trim($_POST['keywords']));	if($keywords != "") $allkeywords = Keycodes::parse_keyw_list($keywords);	$res = Keywords::replace_keywords($nref->ref_key,0,$allkeywords);	$saved = array_values($res);	$deleted = array_keys($res);	if($newrefsaved) { 						// delete holding	    $holdkey = strtoupper(trim($_POST['hold_key']));		$found_records = Holdings::get_by_refkey($holdkey);		$holddeleted = $found_records[0]->delete();		if($holddeleted) $message .= "</br> Holding deleted ".$holdkey;		else $message .= "</br> Could not delete holding ".$holdkey;	}		$fauthorcode = strtoupper(trim($_POST['fauthor']));	$cauthorcode = strtoupper(trim($_POST['cauthor']));	$cauthorpos = trim($_POST['cauthpos']);	if($fauthorcode == $cauthorcode) {		if($fauthorcode != "")		{		// create the only author			$aut['author_key'] = $fauthorcode;			$aut['ref_key'] = $ref->ref_key;			$aut['author_position'] = 1;			$aut['cauthor_flag'] = "Y";			$aut['medi_num'] = $ref->medi_number;						$faut = Authors::instantiateit($aut);			if($faut->save()) {				$found_records = Authors::get_by_refkey($hold_key);				if(isset($found_records)) foreach($found_records as $rec) $rec->delete();				$message .= "</br>First author saved".$faut->author_key;			}			else $message .= "</br>Could not save first author ".$faut->author_key;		}	}	else {		if($fauthorcode != "")		{		// create first author			$aut['author_key'] = $fauthorcode;			$aut['ref_key'] = $ref->ref_key;			$aut['author_position'] = 1;			$aut['medi_num'] = $ref->medi_number;			$faut = Authors::instantiateit($aut);					if($faut->save()) {				$found_records = Authors::get_by_refkey($hold_key);				if(isset($found_records)) foreach($found_records as $rec) $rec->delete();				$message .= "</br>First author saved".$faut->author_key;			}			else $message .= "</br>Could not save first author ".$faut->author_key;		}		if($cauthorcode != "")		{		// create cauthor			$caut['author_key'] = $cauthorcode;			$caut['ref_key'] = $ref->ref_key;			$caut['author_position'] = $cauthorpos;			$caut['medi_num'] = $ref->medi_number;			$caut['cauthor_flag'] = "Y";			$cauth = Authors::instantiateit($caut);						if($cauth->save()) {				$found_records = Authors::get_by_refkey($hold_key);				if(isset($found_records)) foreach($found_records as $rec) $rec->delete();				$message .= "</br>Cor author saved".$cauth->author_key;			}			else $message .= "</br>Could not save cor author ".$cauth->author_key;		}		}	$message .= "</br> Keywords saved - ".$saved[0];	$message .= "</br> Keywords deleted - ".$deleted[0]; } else $message = "Paper processing is not allowed";}if(isset($_POST['delete'])) {	// delete reference Form has been submitted	$message = "Delete is not activated";}?><?php include_layout_template('header.php'); ?><div id="leftcol"><h3>Edit Reference</h3>		<form action="editreference.php" method="post">		  <table>		    <tr>		      <td>Ref code:</td>		      <td>		        <input type="text" name="refkey" size="6" maxlength="6" value="<?php echo $refkey; ?>" />		      </td>		    </tr>			<tr>		      <td >		        <input type="submit" name="getref" value="Get" />			  </td>	  </table>		  </br>		  </br><?php	echo $message."</br>"; ?><?php ?></div>		<div id="data">		<form action="editreference.php" method="post">		  <table>		        <input type="hidden" name="id"  value="<?php echo $ref->id; ?>" />		        <input type="hidden" name="ref_key"  value="<?php echo $ref->ref_key; ?>" />		        <input type="hidden" name="medi_number"  value="<?php echo $ref->medi_number; ?>" />		    <tr>		      <td>Refkey:</td>			  <td><?php echo $ref->ref_key ?></td>		      <td>Type code:</td>		      <td>		        <input type="text" name="type_code" size="1" maxlength="1" value="<?php echo $ref->type_code; ?>" />		      </td>		      <td>Lang code:</td>		      <td>		        <input type="text" name="lang_code" size="3" maxlength="3" value="<?php echo $ref->lang_code; ?>" />		      </td>		      <td>Abstractor:</td>			  <td><?php echo $ref->abstractor ?></td>		    </tr>		    <tr>		      <td>Journal code:</td>		      <td>		        <input type="text" name="journal_code" size="6" maxlength="6" value="<?php echo $ref->journal_code; ?>" />		      </td>			  <td colspan="3"><?php echo $ref->journal_name; ?></td>			  <td>MERDJ:</td>			  <td><?php echo $ref->medi_number; ?></td>		    </tr>		    <tr>		      <td>Vol:</td>		      <td>		        <input type="text" name="vol" size="10" maxlength="20" value="<?php echo $ref->vol; ?>" />		      </td>		      <td>Issue:</td>		      <td>		        <input type="text" name="issue" size="10" maxlength="10" value="<?php echo $ref->issue; ?>" />		      </td>		      <td>Pages:</td>		      <td>		        <input type="text" name="pages" size="10" maxlength="20" value="<?php echo $ref->pages; ?>" />		      </td>		      <td>Year:</td>		      <td>		        <input type="text" name="year" size="4" maxlength="4" value="<?php echo $ref->year; ?>" />		      </td>		    </tr>		    <tr>		      <td>Article title:</td>		      <td colspan="9">		        <textarea rows="4" cols="110" name="article_title"><?php echo $ref->article_title; ?> </textarea>  		      </td>		    </tr>		    <tr>		      <td>Chem abs:</td>		      <td>		        <input type="text" name="chem_abs" size="16" maxlength="16" value="<?php echo $ref->chem_abs; ?>" />		      </td>		      <td>Scisearch:</td>		      <td>		        <input type="text" name="scisearch" size="10" maxlength="10" value="<?php echo $ref->scisearch; ?>" />		      </td>		      <td>Biosis:</td>		      <td>		        <input type="text" name="biosis" size="9" maxlength="9" value="<?php echo $ref->biosis; ?>" />		      </td>		    </tr>		    <tr>		      <td>Asca:</td>		      <td>		        <input type="text" name="asca" size="16" maxlength="20" value="<?php echo $ref->asca; ?>" />		      </td>		      <td>Phys:</td>		      <td>		        <input type="text" name="phys" size="13" maxlength="13" value="<?php echo $phys; ?>" />		      </td>		      <td>Inspec:</td>		      <td>		        <input type="text" name="inspec" size="11" maxlength="11" value="<?php echo $ref->inspec; ?>" />		      </td>		      <td>Energy:</td>		      <td>		        <input type="text" name="energy" size="13" maxlength="13" value="<?php echo $ref->energy; ?>" />		      </td>		    </tr>		    <tr>		      <td>Ldate:</td>		      <td>		        <input type="text" name="ldate" size="10" maxlength="10" value="<?php echo $ref->ldate; ?>" />		      </td>		      <td>Sdate:</td>		      <td>		        <input type="text" name="sdate" size="10" maxlength="10" value="<?php echo $ref->sdate; ?>" />		      </td>		      <td>Rdate:</td>		      <td>		        <input type="text" name="rdate" size="10" maxlength="10" value="<?php echo $ref->rdate; ?>" />		      </td>		      <td>Edate:</td>		      <td>		        <input type="text" name="edate" size="10" maxlength="10" value="<?php echo $ref->edate; ?>" />		      </td>		    </tr>		    <tr>		      <td>Comments:</td>		      <td colspan="9">		        <input type="text" name="comments" size="30" maxlength="30" value="<?php echo $ref->comments; ?>" />		      </td>		    </tr>		    <tr>		      <td>See ref key:</td>		      <td>		        <input type="text" name="see_ref_key" size="6" maxlength="6" value="<?php echo $ref->see_ref_key; ?>" />		      </td>		      <td>Flag code:</td>		      <td>		        <input type="text" name="flag_code" size="1" maxlength="1" value="<?php echo $ref->flag_code; ?>" />		      </td>		      <td>Unsol flag:</td>		      <td>		        <input type="text" name="unsol_flag" size="1" maxlength="1" value="<?php echo $ref->unsol_flag; ?>" />		      </td>		    </tr>		    <tr>		      <td>Abstract:</td>		      <td colspan="9">		        <textarea rows="5" cols="110" name="abstract"><?php echo $ref->abstract; ?> </textarea>  		      </td>		    </tr>		    <tr>		      <td>Citations:</td>		      <td colspan="9">		        <textarea rows="5" cols="110" name="citations"><?php echo $ref->citations; ?> </textarea>  		      </td>		    </tr>		    <tr>		      <td>Index Terms:</td>		      <td colspan="9">		        <textarea rows="5" cols="110" name="index_terms"><?php echo $ref->index_terms; ?> </textarea>  		      </td>		    </tr>		    <tr>		      <td>Keywords:</td>		      <td colspan="9">		        <input type="text" name="keywords" size="120" maxlength="150" value="<?php echo $keywords ?>" />		      </td>		    </tr>		    <tr><td> <div>-</td></tr>		    <tr><td colspan='2'><?php		if(isset($ref))			echo "<input type='submit' name = 'delete' value='Delete' /></td>					<td colspan='2'><input type='submit' name = 'save' value='Save' /></td>";?>		    </td>		    </form>		    <td colspan='2'><?php		if(isset($ref))		    echo "<form action='editdata.php' method='post'>		      <input type='hidden' name='nrefkey' value='".$ref->ref_key."' />		      <input type='submit' name='newdata' value='Add new data' />			  </form>";		?>			</td></tr>		  </table><?php ?></div><?php include_layout_template('footer.php'); ?>		